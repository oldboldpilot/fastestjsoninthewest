# FastestJSONInTheWest C++17 Compatibility CMakeLists.txt
# Author: Olumuyiwa Oluwasanmi
# Header-Only JSON Library with C++17 Compatibility

cmake_minimum_required(VERSION 3.16)

project(FastestJSONInTheWest_CPP17
    VERSION 1.0.0
    LANGUAGES CXX
    DESCRIPTION "Header-Only C++17 JSON Library with SIMD Optimizations"
)

# Detect compiler and version
message(STATUS "Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")

# Set C++17 standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Find optional libraries
find_package(OpenMP QUIET)
find_package(Threads QUIET)

# Enable SIMD optimizations by default
option(ENABLE_SIMD "Enable SIMD optimizations" ON)

# Architecture detection for SIMD
if(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64|AMD64|i386|i686")
    set(TARGET_ARCH "x86")
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64|arm64|ARM64")
    set(TARGET_ARCH "arm64")
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "arm")
    set(TARGET_ARCH "arm32")
else()
    set(TARGET_ARCH "generic")
endif()

message(STATUS "Target Architecture: ${TARGET_ARCH}")

# SIMD capability detection for x86
set(SIMD_FLAGS "")
set(SIMD_DEFINES "")

if(ENABLE_SIMD AND TARGET_ARCH STREQUAL "x86")
    # Check for compiler support of various SIMD instructions
    include(CheckCXXCompilerFlag)
    
    # AVX-512 capabilities
    check_cxx_compiler_flag("-mavx512f" COMPILER_SUPPORTS_AVX512F)
    check_cxx_compiler_flag("-mavx512bw" COMPILER_SUPPORTS_AVX512BW)
    check_cxx_compiler_flag("-mavx512vl" COMPILER_SUPPORTS_AVX512VL)
    check_cxx_compiler_flag("-mavx512dq" COMPILER_SUPPORTS_AVX512DQ)
    check_cxx_compiler_flag("-mavx512cd" COMPILER_SUPPORTS_AVX512CD)
    check_cxx_compiler_flag("-mavx512vbmi" COMPILER_SUPPORTS_AVX512VBMI)
    check_cxx_compiler_flag("-mavx512vbmi2" COMPILER_SUPPORTS_AVX512VBMI2)
    check_cxx_compiler_flag("-mavx512vnni" COMPILER_SUPPORTS_AVX512VNNI)
    
    # Advanced Intel extensions
    check_cxx_compiler_flag("-mamx-tile" COMPILER_SUPPORTS_AMX_TILE)
    check_cxx_compiler_flag("-mamx-int8" COMPILER_SUPPORTS_AMX_INT8)
    check_cxx_compiler_flag("-mamx-bf16" COMPILER_SUPPORTS_AMX_BF16)
    check_cxx_compiler_flag("-mavx512bf16" COMPILER_SUPPORTS_AVX512BF16)
    
    # Standard SIMD
    check_cxx_compiler_flag("-mavx2" COMPILER_SUPPORTS_AVX2)
    check_cxx_compiler_flag("-mavx" COMPILER_SUPPORTS_AVX)
    check_cxx_compiler_flag("-msse4.2" COMPILER_SUPPORTS_SSE42)
    check_cxx_compiler_flag("-msse4.1" COMPILER_SUPPORTS_SSE41)
    check_cxx_compiler_flag("-mssse3" COMPILER_SUPPORTS_SSSE3)
    check_cxx_compiler_flag("-msse3" COMPILER_SUPPORTS_SSE3)
    check_cxx_compiler_flag("-msse2" COMPILER_SUPPORTS_SSE2)
    
    # Build SIMD capability list
    set(SIMD_LEVELS "")
    
    if(COMPILER_SUPPORTS_AMX_TILE AND COMPILER_SUPPORTS_AMX_INT8)
        list(APPEND SIMD_FLAGS "-mamx-tile" "-mamx-int8")
        list(APPEND SIMD_DEFINES "-DHAVE_AMX")
        list(APPEND SIMD_LEVELS "AMX")
    endif()
    
    if(COMPILER_SUPPORTS_AVX512VNNI)
        list(APPEND SIMD_FLAGS "-mavx512vnni")
        list(APPEND SIMD_DEFINES "-DHAVE_AVX512_VNNI")
        list(APPEND SIMD_LEVELS "AVX-512-VNNI")
    endif()
    
    if(COMPILER_SUPPORTS_AVX512VBMI2)
        list(APPEND SIMD_FLAGS "-mavx512vbmi2")
        list(APPEND SIMD_DEFINES "-DHAVE_AVX512_VBMI2")
        list(APPEND SIMD_LEVELS "AVX-512-VBMI2")
    endif()
    
    if(COMPILER_SUPPORTS_AVX512VBMI)
        list(APPEND SIMD_FLAGS "-mavx512vbmi")
        list(APPEND SIMD_DEFINES "-DHAVE_AVX512_VBMI")
        list(APPEND SIMD_LEVELS "AVX-512-VBMI")
    endif()
    
    if(COMPILER_SUPPORTS_AVX512F AND COMPILER_SUPPORTS_AVX512BW)
        list(APPEND SIMD_FLAGS "-mavx512f" "-mavx512bw" "-mavx512vl" "-mavx512dq" "-mavx512cd")
        list(APPEND SIMD_DEFINES "-DHAVE_AVX512F" "-DHAVE_AVX512BW")
        list(APPEND SIMD_LEVELS "AVX-512")
    endif()
    
    if(COMPILER_SUPPORTS_AVX2)
        list(APPEND SIMD_FLAGS "-mavx2")
        list(APPEND SIMD_DEFINES "-DHAVE_AVX2")
        list(APPEND SIMD_LEVELS "AVX2")
    endif()
    
    if(COMPILER_SUPPORTS_AVX)
        list(APPEND SIMD_FLAGS "-mavx")
        list(APPEND SIMD_DEFINES "-DHAVE_AVX")
        list(APPEND SIMD_LEVELS "AVX")
    endif()
    
    if(COMPILER_SUPPORTS_SSE42)
        list(APPEND SIMD_FLAGS "-msse4.2")
        list(APPEND SIMD_DEFINES "-DHAVE_SSE42")
        list(APPEND SIMD_LEVELS "SSE4.2")
    endif()
    
    if(COMPILER_SUPPORTS_SSE41)
        list(APPEND SIMD_FLAGS "-msse4.1")
        list(APPEND SIMD_DEFINES "-DHAVE_SSE41")
        list(APPEND SIMD_LEVELS "SSE4.1")
    endif()
    
    if(COMPILER_SUPPORTS_SSSE3)
        list(APPEND SIMD_FLAGS "-mssse3")
        list(APPEND SIMD_DEFINES "-DHAVE_SSSE3")
        list(APPEND SIMD_LEVELS "SSSE3")
    endif()
    
    if(COMPILER_SUPPORTS_SSE3)
        list(APPEND SIMD_FLAGS "-msse3")
        list(APPEND SIMD_DEFINES "-DHAVE_SSE3")
        list(APPEND SIMD_LEVELS "SSE3")
    endif()
    
    if(COMPILER_SUPPORTS_SSE2)
        list(APPEND SIMD_FLAGS "-msse2")
        list(APPEND SIMD_DEFINES "-DHAVE_SSE2")
        list(APPEND SIMD_LEVELS "SSE2")
    endif()
    
    # Add additional optimization flags
    list(APPEND SIMD_FLAGS "-mpopcnt" "-mbmi" "-mbmi2" "-mlzcnt")
    
    if(SIMD_LEVELS)
        string(JOIN " â†’ " SIMD_LEVELS_STR ${SIMD_LEVELS})
        message(STATUS "SIMD Optimizations: ${SIMD_LEVELS_STR}")
    else()
        message(STATUS "SIMD Optimizations: None detected")
    endif()
endif()

# Set common compiler flags
set(COMMON_FLAGS
    -O3
    -ffast-math
    -funroll-loops
    -fvectorize
    -fslp-vectorize
    -Wall
    -Wextra
    -Wpedantic
    -Wno-unused-parameter
)

# C++17 Compatible Header-Only Test
add_executable(test_cpp17
    test_cpp17.cpp
)

target_include_directories(test_cpp17 PRIVATE ${CMAKE_CURRENT_SOURCE_DIR})

target_compile_options(test_cpp17 PRIVATE ${COMMON_FLAGS})

if(ENABLE_SIMD AND SIMD_FLAGS)
    target_compile_options(test_cpp17 PRIVATE ${SIMD_FLAGS})
    target_compile_definitions(test_cpp17 PRIVATE ${SIMD_DEFINES} FASTJSON_ENABLE_SIMD)
endif()

if(OpenMP_CXX_FOUND)
    target_link_libraries(test_cpp17 PRIVATE OpenMP::OpenMP_CXX)
    message(STATUS "OpenMP: Enabled")
else()
    message(STATUS "OpenMP: Not found")
endif()

if(Threads_FOUND)
    target_link_libraries(test_cpp17 PRIVATE Threads::Threads)
    message(STATUS "Threading: Enabled")
endif()

# Legacy compatibility test (no SIMD, basic optimizations)
add_executable(test_legacy
    test_cpp17.cpp
)

target_include_directories(test_legacy PRIVATE ${CMAKE_CURRENT_SOURCE_DIR})

target_compile_options(test_legacy PRIVATE
    -O2
    -Wall
    -Wextra
    -Wpedantic
    -Wno-unused-parameter
)

target_compile_definitions(test_legacy PRIVATE FASTJSON_LEGACY_MODE)

# Print configuration summary
message(STATUS "")
message(STATUS "=== FastestJSONInTheWest C++17 Configuration ===")
message(STATUS "Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "C++ Standard: C++${CMAKE_CXX_STANDARD}")
message(STATUS "Architecture: ${CMAKE_SYSTEM_PROCESSOR} (${TARGET_ARCH})")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "SIMD Support: ${ENABLE_SIMD}")
if(OpenMP_CXX_FOUND)
    message(STATUS "OpenMP: ${OpenMP_CXX_VERSION}")
endif()
message(STATUS "===============================================")