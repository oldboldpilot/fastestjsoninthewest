// FastestJSONInTheWest Build Service Definitions
// Author: Olumuyiwa Oluwasanmi
// gRPC service for build coordination and CMake integration

syntax = "proto3";

package fastjson.build;

option cxx_namespace = "fastjson::build";
option cc_enable_arenas = true;

// ============================================================================
// Build System Types
// ============================================================================

enum BuildType {
    BUILD_DEBUG = 0;
    BUILD_RELEASE = 1;
    BUILD_RELWITHDEBINFO = 2;
    BUILD_MINSIZEREL = 3;
}

enum CompilerType {
    COMPILER_CLANG = 0;
    COMPILER_GCC = 1;
    COMPILER_MSVC = 2;
}

enum TargetType {
    TARGET_EXECUTABLE = 0;
    TARGET_STATIC_LIBRARY = 1;
    TARGET_SHARED_LIBRARY = 2;
    TARGET_MODULE_LIBRARY = 3;
    TARGET_PYTHON_MODULE = 4;
}

message CompilerInfo {
    CompilerType type = 1;
    string version = 2;
    string executable_path = 3;
    repeated string supported_standards = 4;
    bool supports_modules = 5;
    bool supports_concepts = 6;
    repeated string optimization_flags = 7;
}

message BuildTarget {
    string name = 1;
    TargetType type = 2;
    repeated string sources = 3;
    repeated string headers = 4;
    repeated string module_interfaces = 5;
    repeated string dependencies = 6;
    map<string, string> properties = 7;
    repeated string compile_definitions = 8;
    repeated string compile_options = 9;
    repeated string link_libraries = 10;
}

message CMakeProject {
    string name = 1;
    string version = 2;
    string description = 3;
    string source_directory = 4;
    string binary_directory = 5;
    repeated BuildTarget targets = 6;
    map<string, string> cache_variables = 7;
    repeated string find_packages = 8;
    repeated string subdirectories = 9;
}

message BuildConfiguration {
    BuildType build_type = 1;
    CompilerInfo compiler = 2;
    string install_prefix = 3;
    bool enable_testing = 4;
    bool enable_benchmarking = 5;
    bool enable_python_bindings = 6;
    bool enable_grpc_support = 7;
    bool enable_mpi_support = 8;
    bool enable_simd_optimization = 9;
    map<string, string> environment_variables = 10;
    repeated string cmake_args = 11;
}

// ============================================================================
// Build Service Definition
// ============================================================================

service BuildService {
    // Project configuration
    rpc ConfigureProject(ConfigureProjectRequest) returns (ConfigureProjectResponse);
    rpc UpdateConfiguration(UpdateConfigurationRequest) returns (UpdateConfigurationResponse);
    rpc GetConfiguration(GetConfigurationRequest) returns (GetConfigurationResponse);
    
    // Build operations
    rpc Build(BuildRequest) returns (BuildResponse);
    rpc CleanBuild(CleanBuildRequest) returns (CleanBuildResponse);
    rpc Install(InstallRequest) returns (InstallResponse);
    
    // Dependency management
    rpc FindDependencies(FindDependenciesRequest) returns (FindDependenciesResponse);
    rpc InstallDependencies(InstallDependenciesRequest) returns (InstallDependenciesResponse);
    
    // Code generation and analysis
    rpc GenerateCMakeLists(GenerateCMakeListsRequest) returns (GenerateCMakeListsResponse);
    rpc AnalyzeDependencies(AnalyzeDependenciesRequest) returns (AnalyzeDependenciesResponse);
    
    // Build monitoring
    rpc StreamBuildOutput(StreamBuildRequest) returns (stream BuildOutputMessage);
    rpc GetBuildMetrics(GetBuildMetricsRequest) returns (BuildMetricsResponse);
}

// ============================================================================
// Request/Response Message Types
// ============================================================================

message ConfigureProjectRequest {
    string project_path = 1;
    BuildConfiguration config = 2;
    bool force_reconfigure = 3;
    repeated string additional_cmake_args = 4;
}

message ConfigureProjectResponse {
    bool success = 1;
    string configure_output = 2;
    string error_message = 3;
    CMakeProject project_info = 4;
    repeated string warnings = 5;
    int64 configure_duration_ms = 6;
}

message UpdateConfigurationRequest {
    string project_path = 1;
    map<string, string> updated_variables = 2;
    bool reconfigure_immediately = 3;
}

message UpdateConfigurationResponse {
    bool success = 1;
    string error_message = 2;
    BuildConfiguration current_config = 3;
}

message GetConfigurationRequest {
    string project_path = 1;
    bool include_cache_variables = 2;
}

message GetConfigurationResponse {
    BuildConfiguration config = 1;
    CMakeProject project_info = 2;
    map<string, string> cache_variables = 3;
}

message BuildRequest {
    string project_path = 1;
    repeated string target_names = 2; // Empty means build all
    bool parallel_build = 3;
    int32 parallel_jobs = 4;
    bool verbose_output = 5;
    bool continue_on_error = 6;
}

message BuildResponse {
    bool success = 1;
    string build_output = 2;
    string error_message = 3;
    repeated string built_targets = 4;
    repeated string failed_targets = 5;
    int64 build_duration_ms = 6;
    BuildMetrics metrics = 7;
}

message CleanBuildRequest {
    string project_path = 1;
    bool remove_cmake_cache = 2;
    bool remove_build_artifacts = 3;
}

message CleanBuildResponse {
    bool success = 1;
    string clean_output = 2;
    repeated string removed_files = 3;
}

message InstallRequest {
    string project_path = 1;
    string install_prefix = 2;
    repeated string components = 3; // Empty means install all
}

message InstallResponse {
    bool success = 1;
    string install_output = 2;
    repeated string installed_files = 3;
    string installation_prefix = 4;
}

message FindDependenciesRequest {
    repeated string package_names = 1;
    repeated string search_paths = 2;
    bool use_pkg_config = 3;
    bool search_system_paths = 4;
}

message FindDependenciesResponse {
    repeated DependencyInfo found_dependencies = 1;
    repeated string not_found_packages = 2;
    map<string, string> suggested_installation_commands = 3;
}

message DependencyInfo {
    string name = 1;
    string version = 2;
    repeated string include_directories = 3;
    repeated string library_paths = 4;
    repeated string libraries = 5;
    repeated string compile_definitions = 6;
    string cmake_target = 7;
}

message InstallDependenciesRequest {
    repeated string package_names = 1;
    bool use_source_compilation = 2;
    string install_prefix = 3;
    map<string, string> build_options = 4;
}

message InstallDependenciesResponse {
    bool success = 1;
    repeated string installed_packages = 2;
    repeated string failed_packages = 3;
    string installation_log = 4;
    map<string, string> installation_paths = 5;
}

message GenerateCMakeListsRequest {
    string project_path = 1;
    CMakeProject project_template = 2;
    bool overwrite_existing = 3;
    bool generate_find_modules = 4;
}

message GenerateCMakeListsResponse {
    bool success = 1;
    string generated_cmake_content = 2;
    repeated string generated_files = 3;
    string error_message = 4;
}

message AnalyzeDependenciesRequest {
    string project_path = 1;
    bool analyze_transitive_deps = 2;
    bool check_version_conflicts = 3;
}

message AnalyzeDependenciesResponse {
    repeated DependencyInfo direct_dependencies = 1;
    repeated DependencyInfo transitive_dependencies = 2;
    repeated string version_conflicts = 3;
    repeated string missing_dependencies = 4;
    string dependency_graph = 5; // DOT format
}

message StreamBuildRequest {
    string project_path = 1;
    BuildRequest build_request = 2;
}

message BuildOutputMessage {
    int64 timestamp = 1;
    string level = 2; // "INFO", "WARNING", "ERROR"
    string source = 3; // "cmake", "make", "compiler"
    string message = 4;
    string target_name = 5;
    float progress_percentage = 6;
}

message GetBuildMetricsRequest {
    string project_path = 1;
    bool include_historical_data = 2;
}

message BuildMetrics {
    int64 total_build_time_ms = 1;
    int64 configure_time_ms = 2;
    int64 compile_time_ms = 3;
    int64 link_time_ms = 4;
    int32 total_targets = 5;
    int32 successful_targets = 6;
    int32 failed_targets = 7;
    int32 cache_hits = 8;
    int32 cache_misses = 9;
    int64 total_source_lines = 10;
    float compilation_rate_lines_per_second = 11;
}

message BuildMetricsResponse {
    BuildMetrics current_metrics = 1;
    repeated BuildMetrics historical_metrics = 2;
    map<string, float> performance_trends = 3;
}